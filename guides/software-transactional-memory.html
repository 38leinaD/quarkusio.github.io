<!DOCTYPE html>
<html>

<head>
  <title>Using Software Transactional Memory in Quarkus</title>
  <script id="adobe_dtm" src="https://www.redhat.com/dtm.js" type="text/javascript"></script>
  <script src="/assets/javascript/highlight.pack.js" type="text/javascript"></script>
  <META HTTP-EQUIV='Content-Security-Policy' CONTENT="default-src 'none'; script-src 'self' 'unsafe-eval' 'sha256-ANpuoVzuSex6VhqpYgsG25OHWVA1I+F6aGU04LoI+5s=' 'sha256-ipy9P/3rZZW06mTLAR0EnXvxSNcnfSDPLDuh3kzbB1w=' js.bizographics.com https://www.redhat.com assets.adobedtm.com jsonip.com https://ajax.googleapis.com https://www.googletagmanager.com https://www.google-analytics.com https://use.fontawesome.com; style-src 'self' https://fonts.googleapis.com https://use.fontawesome.com; img-src 'self' *; media-src 'self' ; frame-src https://www.googletagmanager.com https://www.youtube.com; frame-ancestors 'none'; base-uri 'none'; object-src 'none'; form-action 'none'; font-src 'self' https://use.fontawesome.com https://fonts.gstatic.com;">
  <META HTTP-EQUIV='X-Frame-Options' CONTENT="DENY">
  <META HTTP-EQUIV='X-XSS-Protection' CONTENT="1; mode=block">
  <META HTTP-EQUIV='X-Content-Type-Options' CONTENT="nosniff">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Quarkus: Supersonic Subatomic Java">
  <link rel="canonical" href="https://quarkus.io/guides/software-transactional-memory">
  <link rel="shortcut icon" type="image/png" href="/favicon.ico" >
  <link rel="stylesheet" href="https://quarkus.io/guides/stylesheet/config.css" />
  <link rel="stylesheet" href="/assets/css/main.css" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">
  <link rel="alternate" type="application/rss+xml"  href="https://quarkus.io/feed.xml" title="Quarkus">
  <script src="https://quarkus.io/assets/javascript/goan.js" type="text/javascript"></script>
  <script src="https://quarkus.io/assets/javascript/hl.js" type="text/javascript"></script>
</head>

<body class="guides">
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NJWS5L"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->

  <div class="navigation-wrapper">
  <div class="width-12-12">
    <div class="header navigation">
      <div class="logo-wrapper">
        
          <a href="/"><img src="/assets/images/quarkus_logo_horizontal_rgb_600px_reverse.png" class="project-logo" title="Quarkus"></a>
        
      </div>
      <div class="nav-container">
        <nav>
          <div class="nav-mobile"><a id="nav-toggle" href="#!"><span></span></a></div>
          <ul class="nav-list">
            <li>
              <a href="/get-started/" class="">Get Started</a>
            </li>
            <li>
              <a href="/guides/" class="active">Guides</a>
            </li>
            <li>
              <a href="/community/" class="">Community</a>
            </li>
            <li>
              <a href="/blog/" class="">Blog</a>
            </li>
            <li>
              <a href="https://code.quarkus.io" class="button-cta secondary white">Start Coding</a>
            </li>
          </ul>
        </nav>
      </div>
    </div>
  </div>
</div>

  <div class="content">
    <div class="guide">
  <div class="width-12-12">
    <h1 class="text-caps">Using Software Transactional Memory in Quarkus</h1>
    <div class="hide-mobile toc"><ul class="sectlevel1">
<li><a href="#setting-it-up">Setting it up</a></li>
<li><a href="#defining-transactional-objects">Defining Transactional Objects</a></li>
<li><a href="#creating-stm-objects">Creating STM objects</a></li>
<li><a href="#defining-transaction-boundaries">Defining transaction boundaries</a>
<ul class="sectlevel2">
<li><a href="#declarative-approach">Declarative approach</a></li>
<li><a href="#api-approach">API approach</a></li>
</ul>
</li>
<li><a href="#concurrency-behaviour">Concurrency behaviour</a></li>
</ul></div>
    <div>
      <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Quarkus supports the Software Transactional Memory (STM) implementation provided by the
Narayana open source project. Narayana STM allows a program to group object accesses into
a transaction such that other transactions either see all of the changes at once or they
see none of them.</p>
</div>
<div class="paragraph">
<p>STM offers an approach to developing transactional applications in a highly concurrent
environment with some of the same characteristics of ACID (Atomicity, Consistency,
Isolation and Durability) transactions.</p>
</div>
<div class="paragraph">
<p>To use Narayana STM you must define which objects you would like to be transactional using java
annotations. Please refer to the <a href="https://narayana.io/docs/project/index.html#d0e16066">Narayana STM manual</a>
and the <a href="https://narayana.io//docs/project/index.html#d0e16133">STM annotations guide</a> for more details.</p>
</div>
<div class="paragraph">
<p>There is also a fully worked example in the quickstarts which you may access by cloning the
Git repository: <code>git clone <a href="https://github.com/quarkusio/quarkus-quickstarts.git" class="bare">https://github.com/quarkusio/quarkus-quickstarts.git</a></code>, or by downloading an <a href="https://github.com/quarkusio/quarkus-quickstarts/archive/master.zip">archive</a>.
Look for the <code>software-transactional-memory-quickstart</code> example.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="setting-it-up"><a class="anchor" href="#setting-it-up"></a>Setting it up</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To use the extension include it as a dependency in your application pom:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependencies&gt;
    &lt;!-- STM extension --&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
      &lt;artifactId&gt;quarkus-narayana-stm&lt;/artifactId&gt;
      &lt;version&gt;${quarkus.version}&lt;/version&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now you may use the STM library just like you would normally use it. But briefly, the process is:</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="defining-transactional-objects"><a class="anchor" href="#defining-transactional-objects"></a>Defining Transactional Objects</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Transactional objects must implement an interface. Add the <code>org.jboss.stm.annotations.Transactional</code> annotation to the
interfaces that you wish to be managed by a transactional container. For example</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Transactional
public interface FlightService {
    int getNumberOfBookings();
    void makeBooking(String details);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Unless specified using other annotations, all public methods of implementations of this object will be assumed to modify the state of the object.
Please refer to the Narayana guide for details of how to exert finer grained control over the transactional behaviour of objects that implement
interfaces marked with the <code>@Transactional</code> annotation.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="creating-stm-objects"><a class="anchor" href="#creating-stm-objects"></a>Creating STM objects</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The STM library needs to be told which objects it should be managing by providing a container for the transactional memory.
The default container (<code>org.jboss.stm.Container</code>) provides support for volatile objects that cannot be shared between JVMs
(although other constructors do allow for other models):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">    import org.jboss.stm.Container;

    ...

    Container&lt;FlightService&gt; container = new Container&lt;&gt;(); <i class="conum" data-value="1"></i><b>(1)</b>
    FlightServiceImpl instance = new FlightServiceImpl(); <i class="conum" data-value="2"></i><b>(2)</b>
    FlightService flightServiceProxy = container.create(instance); <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>You need to tell each Container about the type of objects for which it will be responsible. In this example
it will be instances that implement the FlightService interface.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Then you create an instance that implements FlightService. You cannot use it directly at this stage because
its operations aren&#8217;t being monitored by the Container.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>To obtain a managed instance, pass the instance to the <code>container</code> to obtain a reference through which you
will be able perform transactional operations. This reference can be used safely from multiple threads
(provided that each thread uses it in a transaction context - see the next section.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="defining-transaction-boundaries"><a class="anchor" href="#defining-transaction-boundaries"></a>Defining transaction boundaries</h2>
<div class="sectionbody">
<div class="paragraph">
<p>STM objects must be accessed within a transaction (otherwise they will behave just like any other java object).
You can define the transaction boundary in two ways:</p>
</div>
<div class="sect2">
<h3 id="declarative-approach"><a class="anchor" href="#declarative-approach"></a>Declarative approach</h3>
<div class="paragraph">
<p>The easiest, but less flexible, way to define your transaction boundaries is to place an <code>@NestedTopLevel</code> or <code>@Nested</code> annotation on the interface.
Then when a method of your transactional object is invoked a new transaction will be created for the duration of the method call.</p>
</div>
</div>
<div class="sect2">
<h3 id="api-approach"><a class="anchor" href="#api-approach"></a>API approach</h3>
<div class="paragraph">
<p>The more flexible approach is to manually start a transaction before accessing methods of transactional objects:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">AtomicAction aa = new AtomicAction(); <i class="conum" data-value="1"></i><b>(1)</b>

aa.begin(); <i class="conum" data-value="2"></i><b>(2)</b>
{
    try {
        flightService.makeBooking("BA123 ...");
        taxiService.makeBooking("East Coast Taxis ..."); <i class="conum" data-value="3"></i><b>(3)</b>
        <i class="conum" data-value="4"></i><b>(4)</b>
        aa.commit();
        <i class="conum" data-value="5"></i><b>(5)</b>
    } catch (Exception e) {
        aa.abort(); <i class="conum" data-value="6"></i><b>(6)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>An object for manually controlling transaction boundaries (AtomicAction and many other useful
classes are included in the extension).
Refer <a href="https://narayana.io//docs/api/com/arjuna/ats/arjuna/AtomicAction.html">to the javadoc</a> for more detail.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Programmatically begin a transaction.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Notice that object updates can be composed which means that updates to multiple objects can be committed together as a single action.
[Note that it is also possible to begin nested transactions so that you can perform speculative work which may then be abandoned
without abandoning other work performed by the outer transaction].</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Since the transaction has not yet been committed the changes made by the flight and taxi services are not visible outside of the transaction.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Since the commit was successful the changes made by the flight and taxi services are now visible to other threads.
Note that other transactions that relied on the old state may or may not now incur conflicts when they commit (the STM library
provides a number of features for managing conflicting behaviour and these are covered in the Narayana STM manual).</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Programmatically decide to abort the transaction which means that the changes made by the flight and taxi services are discarded.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="concurrency-behaviour"><a class="anchor" href="#concurrency-behaviour"></a>Concurrency behaviour</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The goal of STM is to simplify object reads and writes from multiple threads.
Threads are responsible for starting their own transactions before accessing
a transactional object. The STM library will safely manage any conflicts between
these threads. For example, if the access mode is pessimistic (the default),
and a thread enters a transactional method then other threads may be blocked
until the first thread leaves the method. This blocking behaviour may be modified
using suitable STM annotations. Optimistic concurrency is also supported: in
this mode conflicts are checked only at commit time and a thread may be forced
to abort if another thread has made conflicting updates.</p>
</div>
<div class="paragraph">
<p>Remark: sharing a transaction between multiple threads is possible but is currently
an advanced use case only and the Narayana documentation should be consulted
if this behaviour is required. In particular, STM does not yet support the features
described in the <a href="context-propagation">Context Propagation guide</a>.</p>
</div>
</div>
</div>
    </div>
  </div>
</div>

  </div>

  <div class="content project-footer">
  <div class="footer-section">
    <div class="logo-wrapper">
      <a href="/"><img src="/assets/images/quarkus_logo_horizontal_rgb_reverse.svg" class="project-logo" title="Quarkus"></a>
    </div>
  </div>
  <div class="grid-wrapper">
    <p class="grid__item width-3-12">Quarkus is open. All dependencies of this project are available under the <a href='https://www.apache.org/licenses/LICENSE-2.0' target='_blank'>Apache Software License 2.0</a> or compatible license.<br /><br />This website was built with <a href='https://jekyllrb.com/' target='_blank'>Jekyll</a> is hosted on <a href='https://pages.github.com/' target='_blank'>Github Pages</a> and is completely open source. If you want to make it better, <a href='https://github.com/quarkusio/quarkusio.github.io' target='_blank'>fork the website</a> and show us what you’ve got.</p>

    
      <div class="width-1-12 project-links">
        <span>Navigation</span>
        <ul class="footer-links width-1-12">
          
            <li><a href="/">Home</a></li>
          
            <li><a href="/guides">Guides</a></li>
          
            <li><a href="/community/#contributing">Contribute</a></li>
          
            <li><a href="/faq">FAQ</a></li>
          
            <li><a href="/get-started">Get Started</a></li>
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>Contribute</span>
        <ul class="footer-links width-1-12">
          
            <li><a href="https://twitter.com/quarkusio">Follow us</a></li>
          
            <li><a href="https://github.com/quarkusio">GitHub</a></li>
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>Get Help</span>
        <ul class="footer-links width-1-12">
          
            <li><a href="https://groups.google.com/forum/#!forum/quarkus-dev">Forums</a></li>
          
            <li><a href="https://quarkusio.zulipchat.com">Chatroom</a></li>
          
        </ul>
      </div>
    

    
      <div class="width-3-12 more-links">
        <span>Quarkus is made of community projects</span>
        <ul class="footer-links">
          
            <li><a href="https://vertx.io/" target="_blank">Eclipse Vert.x</a></li>
          
            <li><a href="https://microprofile.io" target="_blank">Eclipse MicroProfile</a></li>
          
            <li><a href="https://hibernate.org" target="_blank">Hibernate</a></li>
          
            <li><a href="https://netty.io" target="_blank">Netty</a></li>
          
            <li><a href="https://resteasy.github.io" target="_blank">RESTEasy</a></li>
          
            <li><a href="https://camel.apache.org" target="_blank">Apache Camel</a></li>
          
            <li><a href="https://code.quarkus.io/" target="_blank">And many more...</a></li>
          
        </ul>
      </div>
    
  </div>
</div>
  <div class="content redhat-footer">
  <div class="grid-wrapper">
    <span class="licence">
      <i class="fab fa-creative-commons"></i><i class="fab fa-creative-commons-by"></i> <a href="https://creativecommons.org/licenses/by/3.0/" target="_blank">CC by 3.0</a>
    </span>
    <span class="redhat">
      Sponsored by
    </span>
    <span class="redhat-logo">
      <a href="https://www.redhat.com/" target="_blank"><img src="/assets/images/redhat_reversed.svg"></a>
    </span>
  </div>
</div>


  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js" integrity="sha384-8gBf6Y4YYq7Jx97PIqmTwLPin4hxIzQw5aDmUg/DDhul9fFpbbLcLh3nTIIDJKhx" crossorigin="anonymous"></script>
  <script type="text/javascript" src="/assets/javascript/mobile-nav.js"></script>
  <script type="text/javascript" src="/assets/javascript/scroll-down.js"></script>
  <script src="/assets/javascript/satellite.js" type="text/javascript"></script>
  <script src="https://quarkus.io/guides/javascript/config.js" type="text/javascript"></script>
</body>

</html>
